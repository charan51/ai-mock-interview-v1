name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install AWS CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y awscli

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-2  # Region where the EC2 instance and SSM parameter are located

    - name: Fetch MONGO_URI from SSM Parameter Store
      run: |
        MONGO_URI=$(aws ssm get-parameter --name "/ai-mock-interview/mongo-uri" --with-decryption --query "Parameter.Value" --output text --region us-east-2)
        if [ -z "$MONGO_URI" ]; then
          echo "Failed to fetch MONGO_URI from SSM Parameter Store"
          exit 1
        fi
        echo "MONGO_URI=$MONGO_URI" >> $GITHUB_ENV

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/ai_mock_interview.pem
        chmod 600 ~/.ssh/ai_mock_interview.pem
        ssh-keyscan -H 3.141.202.227 >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      run: |
        ssh -i ~/.ssh/ai_mock_interview.pem ec2-user@3.141.202.227 << 'EOF'
          # Navigate to the project directory
          cd /home/ec2-user/ai-mock-interview || { echo "Directory not found"; exit 1; }

          # Pull the latest code from the repository (if the repo is cloned on EC2)
          git pull origin main || echo "Failed to pull latest code, continuing..."

          # Export MONGO_URI to the environment
          export MONGO_URI="${{ env.MONGO_URI }}"

          # Pull the latest images from Docker Hub
          docker-compose pull || { echo "Failed to pull Docker images"; exit 1; }

          # Start the containers
          docker-compose up -d --remove-orphans || { echo "Failed to start containers"; exit 1; }

          # Clean up unused images and containers
          docker system prune -f
        EOF

    - name: Cleanup SSH
      if: always()
      run: |
        rm -f ~/.ssh/ai_mock_interview.pem
        rm -f ~/.ssh/known_hosts
