name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4 # Updated to the latest version

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/ai_mock_interview.pem
        chmod 600 ~/.ssh/ai_mock_interview.pem
        ssh-keyscan -H 54.90.228.139 >> ~/.ssh/known_hosts # Add EC2 host to known_hosts to avoid host key verification prompt

    - name: Deploy to EC2
      run: |
        ssh -i ~/.ssh/ai_mock_interview.pem ec2-user@54.90.228.139 << 'EOF'
          # Navigate to the project directory (adjust path as needed)
          cd /home/ec2-user/ai-mock-interview

          # Pull the latest code from the repository (optional, if code is on EC2)
          git pull origin main || echo "Failed to pull latest code, continuing..."

          # Pull the latest images from Docker Hub
          docker-compose pull

          # Start the containers
          docker-compose up -d --remove-orphans

          # Clean up unused images and containers to save space
          docker system prune -f
        EOF

    - name: Cleanup SSH
      if: always() # Run even if previous steps fail
      run: |
        rm -f ~/.ssh/ai_mock_interview.pem
        rm -f ~/.ssh/known_hosts